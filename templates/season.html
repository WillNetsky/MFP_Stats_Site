{% extends "base.html" %}

{% block title %}{{ season.name }} - Pinball League Stats{% endblock %}

{% block body_class %}season-page{% endblock %}

{% block content %}
    <h1>{{ season.name }}</h1>

    <p><a href="https://app.matchplay.events/series/{{ season.seriesId }}" target="_blank">View on Matchplay.events</a></p>
    {% if finals_tournament_ids %}
        {% if finals_tournament_ids is string or finals_tournament_ids is number %} {# Handle single ID #}
            <p><a href="https://app.matchplay.events/tournaments/{{ finals_tournament_ids }}" target="_blank">View Finals Tournament on Matchplay.events</a></p>
        {% else %} {# Handle list of IDs #}
            <p>View Finals Tournaments on Matchplay.events:
                {% for tid in finals_tournament_ids %}
                    <a href="https://app.matchplay.events/tournaments/{{ tid }}" target="_blank">Part {{ loop.index }}</a>{% if not loop.last %}, {% endif %}
                {% endfor %}
            </p>
        {% endif %}
    {% endif %}

    {% if finals_results %}
        <h2>Finals Results</h2>
        <div class="table-container">
            <table role="grid">
                <thead>
                    <tr>
                        <th>Position</th>
                        <th>Player</th>
                    </tr>
                </thead>
                <tbody>
                    {% for result in finals_results %}
                        <tr>
                            <td>{{ result.position }}</td>
                            <td><a href="player_{{ result.playerId }}.html">{{ result.name }}</a></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    <h2>Player Performance in {{ season.name }}</h2>
    {% if season_players_data %}
        <div class="table-container">
            <table role="grid">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Qualifying Position</th>
                        <th>Total Adjusted Points</th>
                        <th>Total Raw Points</th>
                        <th>Weeks Played</th>
                        <th>Avg Points/Week</th>
                        <th>1st</th>
                        <th>2nd</th>
                        <th>3rd</th>
                        <th>4th (3rd in 3p)</th>
                        <th>2nd (3p)</th>
                        {% for i in range(1, 11) %}
                            <th>Week {{ i }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for player_data in season_players_data %}
                        <tr>
                            <td><a href="player_{{ player_data.playerId }}.html">{{ player_data.name }}</a></td>
                            <td>{{ player_data.qualifying_position }}</td>
                            <td>{{ player_data.total_adjusted_points | format_number }}</td>
                            <td>{{ player_data.total_raw_points | format_number }}</td>
                            <td>{{ player_data.weekly_scores | select('ne', 'N/A') | list | length }}</td>
                            <td>{{ player_data.average_points_per_week | format_number }}</td>
                            <td>{{ player_data.game_outcomes['1st'] }}</td>
                            <td>{{ player_data.game_outcomes['2nd_4p'] }}</td>
                            <td>{{ player_data.game_outcomes['3rd_4p'] }}</td>
                            <td>{{ player_data.game_outcomes['4th_combined'] }}</td>
                            <td>{{ player_data.game_outcomes['2nd_3p'] }}</td>
                            {% for score in player_data.weekly_scores %}
                                <td>{{ score | score_color_code | safe }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No player performance data available for this season.</p>
    {% endif %}
{% endblock %}
