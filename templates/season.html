{% extends "base.html" %}

{% block title %}{{ season.name }} - Pinball League Stats{% endblock %}

{% block body_class %}season-page{% endblock %}

{% block content %}
    <h1>{{ season.name }}</h1>

    <p><a href="https://app.matchplay.events/series/{{ season.seriesId }}" target="_blank">View on Matchplay.events</a></p>

    {% if has_finals == "Yes" %}
        <h2>Finals Results</h2>
        <div class="grid">
            <div class="column">
                <h3>Semi-Finals</h3>
                {% if 'round_1' in finals_data %}
                    {% for group_name, group_data in finals_data['round_1'].groups.items() %}
                        <h4>{{ group_name | replace('_', ' ') | title }}</h4>
                        <table role="grid">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    {% for arena in group_data.arenas %}
                                        <th>{{ arena }}</th>
                                    {% endfor %}
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player_id, player_data in group_data.players.items() %}
                                    <tr>
                                        <td><a href="player_{{ player_id }}.html">{{ player_data.name }}</a></td>
                                        {% for arena in group_data.arenas %}
                                            <td>{{ player_data.games.get(arena, '-') }}</td>
                                        {% endfor %}
                                        <td>{{ player_data.total_points | format_number }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endfor %}
                    {% if finals_data['round_1'].tiebreakers %}
                        <h4>Tiebreakers</h4>
                        <ul>
                            {% for tiebreaker in finals_data['round_1'].tiebreakers %}
                                <li>{{ tiebreaker.winner }} defeated {{ tiebreaker.loser }} on {{ tiebreaker.arena }}</li>
                            {% endfor %}
                        </ul>
                    {% endif %}
                {% endif %}
            </div>
            <div class="column">
                <h3>Finals</h3>
                {% if 'round_2' in finals_data %}
                    {% for group_name, group_data in finals_data['round_2'].groups.items() %}
                        <h4>{{ group_name | replace('_', ' ') | title }}</h4>
                        <table role="grid">
                            <thead>
                                <tr>
                                    <th>Player</th>
                                    {% for arena in group_data.arenas %}
                                        <th>{{ arena }}</th>
                                    {% endfor %}
                                    <th>Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for player_id, player_data in group_data.players.items() %}
                                    <tr>
                                        <td><a href="player_{{ player_id }}.html">{{ player_data.name }}</a></td>
                                        {% for arena in group_data.arenas %}
                                            <td>{{ player_data.games.get(arena, '-') }}</td>
                                        {% endfor %}
                                        <td>{{ player_data.total_points | format_number }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    {% endif %}

    <h2>Player Performance in {{ season.name }}</h2>
    {% if season_players_data %}
        <div class="table-container">
            <table role="grid">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Qualifying Position</th>
                        <th>Total Adjusted Points</th>
                        <th>Total Raw Points</th>
                        <th>Weeks Played</th>
                        <th>Avg Points/Week</th>
                        <th>1st</th>
                        <th>2nd</th>
                        <th>3rd</th>
                        <th>4th (3rd in 3p)</th>
                        <th>2nd (3p)</th>
                        {% for i in range(1, 11) %}
                            <th>Week {{ i }}</th>
                        {% endfor %}
                    </tr>
                </thead>
                <tbody>
                    {% for player_data in season_players_data %}
                        <tr>
                            <td><a href="player_{{ player_data.playerId }}.html">{{ player_data.name }}</a></td>
                            <td>{{ player_data.qualifying_position }}</td>
                            <td>{{ player_data.total_adjusted_points | format_number }}</td>
                            <td>{{ player_data.total_raw_points | format_number }}</td>
                            <td>{{ player_data.weekly_scores | select('ne', 'N/A') | list | length }}</td>
                            <td>{{ player_data.average_points_per_week | format_number }}</td>
                            <td>{{ player_data.game_outcomes['1st'] }}</td>
                            <td>{{ player_data.game_outcomes['2nd_4p'] }}</td>
                            <td>{{ player_data.game_outcomes['3rd_4p'] }}</td>
                            <td>{{ player_data.game_outcomes['4th_combined'] }}</td>
                            <td>{{ player_data.game_outcomes['2nd_3p'] }}</td>
                            {% for score in player_data.weekly_scores %}
                                <td>{{ score | score_color_code | safe }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No player performance data available for this season.</p>
    {% endif %}
{% endblock %}
