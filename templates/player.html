{% extends "base.html" %}

{% block title %}{{ player.name }} - Pinball League Stats{% endblock %}

{% block body_class %}player-page{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        .chart-wrapper {
            margin-bottom: 20px;
        }
        .chart-toggle-button {
            margin-bottom: 10px;
            padding: 8px 15px;
            background-color: var(--primary);
            color: var(--primary-inverse);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }
        .chart-toggle-button:hover {
            opacity: 0.9;
        }
        .chart-container {
            position: relative;
            width: 100%; /* Take full width of its parent */
            max-width: 600px; /* Max width for the chart */
            height: 300px; /* Fixed height for the chart */
            margin: 0 auto; /* Center the chart */
        }
        .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
        }
    </style>
{% endblock %}

{% block content %}
    <h1>{{ player.name }}</h1>
    <p>IFPA Number: {{ player.ifpaId if player.ifpaId else 'N/A' }}</p>

    <h2>MFPinball Seasons</h2>
    {% if mfp_seasons %}
        <div class="chart-wrapper">
            <button class="chart-toggle-button" onclick="toggleChart('mfpPerformanceChartContainer')">Toggle MFPinball Performance Chart</button>
            <div id="mfpPerformanceChartContainer" class="chart-container" style="display: none;">
                <canvas id="mfpPerformanceChart"></canvas>
            </div>
        </div>
        <div class="table-container">
            <table id="mfp-player-seasons-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('mfp-player-seasons-table', 0, true)">Year</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 1)">Season</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 2)">League</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 3, true)">Final Position</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 4)">Trophy</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 5, true)">Total Adjusted Points</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 6, true)">Total Raw Points</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 7, true)">Weeks Played</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 8, true)">Avg Points/Week</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 9, true)">Best Week</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 10, true)">2nd Best</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 11, true)">3rd Best</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 12, true)">4th Best</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 13, true)">5th Best</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 14, true)">6th Best</th>
                    </tr>
                </thead>
                <tbody>
                    {% for season_data in mfp_seasons %}
                        {% set pos = season_data.summary_stats.final_position %}
                        <tr class="{% if pos == 1 %}gold-finish{% elif pos == 2 %}silver-finish{% elif pos == 3 %}bronze-finish{% elif pos == 4 %}fourth-finish{% endif %}">
                            <td>{{ season_data.year }}</td>
                            <td>{{ season_data.season_name }}</td>
                            <td><a href="season_{{ season_data.seriesId }}.html">{{ season_data.league_name }}</a></td>
                            <td>{{ pos }}</td>
                            <td class="trophy-icon"></td>
                            <td>{{ season_data.summary_stats.total_adjusted_points | format_number }}</td>
                            <td>{{ season_data.summary_stats.total_raw_points | format_number }}</td>
                            <td>{{ season_data.summary_stats.weeks_played }}</td>
                            <td>{{ season_data.summary_stats.average_points_per_week | format_number }}</td>
                            {% for score in season_data.summary_stats.top_6_scores %}
                                <td>{{ score | score_color_code | safe }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No MFPinball season data available for this player.</p>
    {% endif %}

    <h2>MFLadies Pinball Seasons</h2>
    {% if mflp_seasons %}
        <div class="chart-wrapper">
            <button class="chart-toggle-button" onclick="toggleChart('mflpPerformanceChartContainer')">Toggle MFLadies Pinball Performance Chart</button>
            <div id="mflpPerformanceChartContainer" class="chart-container" style="display: none;">
                <canvas id="mflpPerformanceChart"></canvas>
            </div>
        </div>
        <div class="table-container">
            <table id="mflp-player-seasons-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('mflp-player-seasons-table', 0, true)">Year</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 1)">Season</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 2)">League</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 3, true)">Final Position</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 4)">Trophy</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 5, true)">Total Adjusted Points</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 6, true)">Total Raw Points</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 7, true)">Weeks Played</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 8, true)">Avg Points/Week</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 9, true)">Best Week</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 10, true)">2nd Best</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 11, true)">3rd Best</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 12, true)">4th Best</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 13, true)">5th Best</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 14, true)">6th Best</th>
                    </tr>
                </thead>
                <tbody>
                    {% for season_data in mflp_seasons %}
                        {% set pos = season_data.summary_stats.final_position %}
                        <tr class="{% if pos == 1 %}gold-finish{% elif pos == 2 %}silver-finish{% elif pos == 3 %}bronze-finish{% elif pos == 4 %}fourth-finish{% endif %}">
                            <td>{{ season_data.year }}</td>
                            <td>{{ season_data.season_name }}</td>
                            <td><a href="season_{{ season_data.seriesId }}.html">{{ season_data.league_name }}</a></td>
                            <td>{{ pos }}</td>
                            <td class="trophy-icon"></td>
                            <td>{{ season_data.summary_stats.total_adjusted_points | format_number }}</td>
                            <td>{{ season_data.summary_stats.total_raw_points | format_number }}</td>
                            <td>{{ season_data.summary_stats.weeks_played }}</td>
                            <td>{{ season_data.summary_stats.average_points_per_week | format_number }}</td>
                            {% for score in season_data.summary_stats.top_6_scores %}
                                <td>{{ score | score_color_code | safe }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No MFLadies Pinball season data available for this player.</p>
    {% endif %}

    <h2>Performance by Machine</h2>
    {% if game_performance %}
        <div class="table-container">
            <table id="game-performance-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('game-performance-table', 0)">Machine</th>
                        <th onclick="sortTable('game-performance-table', 1, true)">Total Plays</th>
                        <th onclick="sortTable('game-performance-table', 2, true)">1st Place Finishes</th>
                        <th onclick="sortTable('game-performance-table', 3, true)">2nd Place Finishes</th>
                        <th onclick="sortTable('game-performance-table', 4, true)">3rd Place Finishes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game_name, stats in game_performance.items() %}
                        <tr>
                            <td>{{ game_name }}</td>
                            <td>{{ stats.total_plays }}</td>
                            <td>{{ stats['1st_place'] }}</td>
                            <td>{{ stats['2nd_place'] }}</td>
                            <td>{{ stats['3rd_place'] }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No game performance data available for this player.</p>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        function toggleChart(chartContainerId) {
            const chartContainer = document.getElementById(chartContainerId);
            if (chartContainer.style.display === 'none') {
                chartContainer.style.display = 'block';
            } else {
                chartContainer.style.display = 'none';
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            // MFPinball Chart
            const mfpChartData = {{ mfp_chart_data | safe }};
            if (mfpChartData.length > 0) {
                const mfpLabels = mfpChartData.map(item => item.label);
                const mfpValues = mfpChartData.map(item => item.value);
                const mfpCtx = document.getElementById('mfpPerformanceChart').getContext('2d');
                new Chart(mfpCtx, {
                    type: 'line',
                    data: {
                        labels: mfpLabels,
                        datasets: [{
                            label: 'Avg Points/Week (MFPinball)',
                            data: mfpValues,
                            borderColor: 'rgb(75, 192, 192)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Average (20)',
                            data: Array(mfpLabels.length).fill(20), // Constant line at 20
                            borderColor: 'rgb(255, 205, 86)', // Yellow/Orange color
                            borderDash: [5, 5], // Dashed line
                            pointRadius: 0, // No points on this line
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Important for fixed height
                        scales: {
                            y: {
                                min: 0,
                                max: 35,
                                title: {
                                    display: true,
                                    text: 'Avg Points/Week'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Season'
                                }
                            }
                        }
                    }
                });
            }

            // MFLadies Pinball Chart
            const mflpChartData = {{ mflp_chart_data | safe }};
            if (mflpChartData.length > 0) {
                const mflpLabels = mflpChartData.map(item => item.label);
                const mflpValues = mflpChartData.map(item => item.value);
                const mflpCtx = document.getElementById('mflpPerformanceChart').getContext('2d');
                new Chart(mflpCtx, {
                    type: 'line',
                    data: {
                        labels: mflpLabels,
                        datasets: [{
                            label: 'Avg Points/Week (MFLadies Pinball)',
                            data: mflpValues,
                            borderColor: 'rgb(255, 99, 132)',
                            tension: 0.1,
                            fill: false
                        },
                        {
                            label: 'Average (20)',
                            data: Array(mflpLabels.length).fill(20), // Constant line at 20
                            borderColor: 'rgb(255, 205, 86)', // Yellow/Orange color
                            borderDash: [5, 5], // Dashed line
                            pointRadius: 0, // No points on this line
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false, // Important for fixed height
                        scales: {
                            y: {
                                min: 0,
                                max: 35,
                                title: {
                                    display: true,
                                    text: 'Avg Points/Week'
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Season'
                                }
                            }
                        }
                    }
                });
            }
        });
    </script>
{% endblock %}
