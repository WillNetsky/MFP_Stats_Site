{% extends "base.html" %}

{% block title %}{{ player.name }} - Pinball League Stats{% endblock %}

{% block body_class %}player-page{% endblock %}

{% block head %}
    {{ super() }}
    <style>
        /* Styles for the new search box */
        .search-container {
            position: relative;
            display: inline-block;
            flex-shrink: 1; /* Allow search container to shrink if needed */
            flex-grow: 1; /* Allow search container to grow and take available space */
            width: 0; /* Allow search container to shrink as much as possible */
            min-width: 0; /* Ensure no minimum width prevents shrinking */
        }
        .search-container input[type="text"] { /* Target search input specifically */
            padding: 5px;
            border-radius: 4px;
            border: 1px solid var(--form-element-border-color);
            background-color: var(--form-element-background-color);
            color: var(--color);
            width: 100%; /* Make input take full width of its flex-grown parent */
        }
        .search-results {
            position: absolute;
            background-color: var(--background-color);
            border: 1px solid var(--form-element-border-color);
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            width: 100%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .search-results div {
            padding: 8px 10px;
            cursor: pointer;
        }
        .search-results div:hover {
            background-color: var(--primary-hover);
            color: var(--primary-inverse);
        }
        .search-input-wrapper {
            display: flex;
            align-items: center;
            gap: 5px;
            flex-shrink: 1; /* Allow search input wrapper to shrink */
            width: auto; /* Allow search input wrapper to take natural width */
        }
        .clear-search-button {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 1em;
            padding: 0 5px;
            width: 50px;
        }
        .clear-search-button:hover {
            color: var(--primary-hover);
        }
    </style>
{% endblock %}

{% block content %}
    <h1>{{ player.name }}</h1>
    <p>IFPA Number: {{ player.ifpaId if player.ifpaId else 'N/A' }}</p>

    {% if mfp_seasons %}
        <h2>MFPinball Seasons</h2>
        <div class="table-container">
            <table id="mfp-player-seasons-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('mfp-player-seasons-table', 0, true)">Year</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 1)">Season</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 2)">League</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 3, true)">Final Position</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 4)">Trophy</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 5, true)">Total Adjusted Points</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 6, true)">Total Raw Points</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 7, true)">Weeks Played</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 8, true)">Avg Points/Week</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 9, true)">Best Week</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 10, true)">2nd Best</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 11, true)">3rd Best</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 12, true)">4th Best</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 13, true)">5th Best</th>
                        <th onclick="sortTable('mfp-player-seasons-table', 14, true)">6th Best</th>
                    </tr>
                </thead>
                <tbody>
                    {% for season_data in mfp_seasons %}
                        {% set stats = season_data.summary_stats %}
                        {% set pos = stats.final_position %}
                        <tr class="{% if pos == 1 %}gold-finish{% elif pos == 2 %}silver-finish{% elif pos == 3 %}bronze-finish{% elif pos == 4 %}fourth-finish{% endif %}">
                            <td>{{ season_data.year }}</td>
                            <td>{{ season_data.season_name }}</td>
                            <td><a href="season_{{ season_data.seriesId }}.html">{{ season_data.league_name }}</a></td>
                            <td>
                                {% if stats.played_in_finals %}
                                    {{ pos }} ({{ stats.qualifying_position }})
                                {% else %}
                                    {{ pos }}
                                {% endif %}
                            </td>
                            <td class="trophy-icon"></td>
                            <td>{{ stats.total_adjusted_points | format_number }}</td>
                            <td>{{ stats.total_raw_points | format_number }}</td>
                            <td>{{ stats.weeks_played }}</td>
                            <td>{{ stats.average_points_per_week | format_number }}</td>
                            {% for score in stats.top_6_scores %}
                                <td>{{ score | score_color_code | safe }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    {% if mflp_seasons %}
        <h2>MFLadies Pinball Seasons</h2>
        <div class="table-container">
            <table id="mflp-player-seasons-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('mflp-player-seasons-table', 0, true)">Year</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 1)">Season</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 2)">League</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 3, true)">Final Position</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 4)">Trophy</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 5, true)">Total Adjusted Points</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 6, true)">Total Raw Points</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 7, true)">Weeks Played</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 8, true)">Avg Points/Week</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 9, true)">Best Week</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 10, true)">2nd Best</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 11, true)">3rd Best</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 12, true)">4th Best</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 13, true)">5th Best</th>
                        <th onclick="sortTable('mflp-player-seasons-table', 14, true)">6th Best</th>
                    </tr>
                </thead>
                <tbody>
                    {% for season_data in mflp_seasons %}
                        {% set stats = season_data.summary_stats %}
                        {% set pos = stats.final_position %}
                        <tr class="{% if pos == 1 %}gold-finish{% elif pos == 2 %}silver-finish{% elif pos == 3 %}bronze-finish{% elif pos == 4 %}fourth-finish{% endif %}">
                            <td>{{ season_data.year }}</td>
                            <td>{{ season_data.season_name }}</td>
                            <td><a href="season_{{ season_data.seriesId }}.html">{{ season_data.league_name }}</a></td>
                            <td>
                                {% if stats.played_in_finals %}
                                    {{ pos }} ({{ stats.qualifying_position }})
                                {% else %}
                                    {{ pos }}
                                {% endif %}
                            </td>
                            <td class="trophy-icon"></td>
                            <td>{{ stats.total_adjusted_points | format_number }}</td>
                            <td>{{ stats.total_raw_points | format_number }}</td>
                            <td>{{ stats.weeks_played }}</td>
                            <td>{{ stats.average_points_per_week | format_number }}</td>
                            {% for score in stats.top_6_scores %}
                                <td>{{ score | score_color_code | safe }}</td>
                            {% endfor %}
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% endif %}

    <h2>Performance by Machine</h2>
    {% if game_performance %}
        <div class="table-container">
            <table id="game-performance-table">
                <thead>
                    <tr>
                        <th onclick="sortTable('game-performance-table', 0)">Machine</th>
                        <th onclick="sortTable('game-performance-table', 1, true)">Total Plays</th>
                        <th onclick="sortTable('game-performance-table', 2, true)">1st Place Finishes</th>
                        <th onclick="sortTable('game-performance-table', 3, true)">2nd Place Finishes</th>
                        <th onclick="sortTable('game-performance-table', 4, true)">3rd Place Finishes</th>
                    </tr>
                </thead>
                <tbody>
                    {% for game_name, stats in game_performance.items() %}
                        <tr>
                            <td>{{ game_name }}</td>
                            <td>{{ stats.total_plays }}</td>
                            <td>{{ stats['1st_place'] }}</td>
                            <td>{{ stats['2nd_place'] }}</td>
                            <td>{{ stats['3rd_place'] }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No game performance data available for this player.</p>
    {% endif %}

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // No chart-specific JavaScript needed on this page anymore.
        // The allPlayersChartData variable is also no longer needed here.
        // The toggleChart, getStatisticLabel, getChartData, getChartLabels, updateChart,
        // handleSearchInput, selectOverlayPlayer, clearOverlayPlayer functions are removed.

        document.addEventListener('DOMContentLoaded', function() {
            // Hide search results when clicking outside
            document.addEventListener('click', function(event) {
                ['mfp', 'mflp'].forEach(leagueType => {
                    const searchContainer = document.querySelector(`#${leagueType}-overlay-search-input`);
                    if (searchContainer) { // Check if element exists before trying to access closest
                        const actualSearchContainer = searchContainer.closest('.search-container');
                        if (actualSearchContainer && !actualSearchContainer.contains(event.target)) {
                            const searchResultsDiv = document.getElementById(`${leagueType}-overlay-search-results`);
                            if (searchResultsDiv) {
                                searchResultsDiv.style.display = 'none';
                            }
                        }
                    }
                });
            });
        });
    </script>
{% endblock %}
